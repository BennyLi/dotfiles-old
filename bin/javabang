#!/bin/bash

JAVA_SCRIPT_LIB_FOLDER_PATH=~/share/java-script-libs/*

{
	read -r skip
	read -r line
	while [ "${line:0:2}" == '# ' ]; do
		if [ "${line:0:7}" == '# main=' ]; then
			mainClass="${line:7}"
		fi
		read -r line
	done

	javaSource=""
	javaClassName=""
	javaPackage=""
	while read -r line; do
		javaSource="$javaSource$line"

		if [ "${line:0:7}" == "package" ]; then
			javaPackage="$(echo $line | sed 's/^package \([a-z\.]*\);$/\1/')"
		fi

		if [ "${line:0:13}" == "public class " ]; then
			javaClassName="$(echo $line | sed 's/^public class \([a-zA-Z]*\).*/\1/')"
		fi
	done

} < "$1"


# create package dir
tmpPath="/tmp/"
tmpPackagePath="$tmpPath$(echo "$javaPackage" | sed 's/\./\//g')/"
mkdir -p $tmpPackagePath

# Put JAVA source file into package dir
tmpClassPath="$tmpPackagePath$javaClassName.java"
echo "$javaSource" > "$tmpClassPath"

# Get external libs from predefined folder
classPath=""
for jar in $JAVA_SCRIPT_LIB_FOLDER_PATH; do
	classPath="$classPath:$jar"
done
# remove first colon
classPath="$(echo $classPath | cut -c 2-)"
#echo $classPath

# Compile and execute
javac -cp $classPath "$tmpClassPath"
cd $tmpPath
java -cp ".:$classPath" $mainClass

# Remove temp files
#rm "$javaClassName.java"
